import { logger } from '@/lib/logger';
import { NextRequest } from 'next/server';
import { successResponse, errorResponse, ERROR_CODES } from '@/lib/api-response';
import { requireCsrfToken } from '@/lib/csrf';
import { cookies } from 'next/headers';
import { createServerClient } from '@supabase/ssr';

/**
 * POST /api/auth/logout
 * Log out the current user and clear session
 */
export async function POST(request: NextRequest) {
  try {
    // CSRF protection
    await requireCsrfToken(request);

    const cookieStore = await cookies();

    // Create Supabase client
    const supabase = createServerClient(
      process.env.NEXT_PUBLIC_SUPABASE_URL!,
      process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
      {
        cookies: {
          getAll() {
            return cookieStore.getAll();
          },
          setAll(cookiesToSet) {
            try {
              cookiesToSet.forEach(({ name, value, options }) => {
                cookieStore.set(name, value, options);
              });
            } catch {
              // Ignore errors
            }
          },
        },
      }
    );

    // Sign out from Supabase
    await supabase.auth.signOut();

    // Clear session cookie
    cookieStore.set('sb-session', '', {
      httpOnly: true,
      secure: process.env.NODE_ENV === 'production',
      sameSite: 'lax',
      path: '/',
      maxAge: 0, // Expire immediately
    });

    return successResponse({
      message: 'Logged out successfully.',
    });
  } catch (error) {
    logger.error('Logout error:', error);
    return errorResponse(
      ERROR_CODES.INTERNAL_ERROR,
      'An error occurred during logout. Please try again.',
      500
    );
  }
}
