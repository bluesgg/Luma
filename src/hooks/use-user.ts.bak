import { logger } from '@/lib/logger';
'use client';

import { useQuery, useQueryClient } from '@tanstack/react-query';
import type { User } from '@prisma/client';

interface UserResponse {
  user: Omit<User, 'passwordHash' | 'failedLoginCount' | 'lockedUntil'>;
}

/**
 * Fetch the current authenticated user
 */
async function fetchCurrentUser(): Promise<UserResponse['user'] | null> {
  try {
    const response = await fetch('/api/auth');

    if (!response.ok) {
      return null;
    }

    const result = await response.json();

    if (!result.success) {
      return null;
    }

    return result.data.user;
  } catch (error) {
    logger.error('Error fetching current user:', error);
    return null;
  }
}

/**
 * Hook to get the current authenticated user
 * Uses TanStack Query for caching and automatic refetching
 */
export function useUser() {
  const queryClient = useQueryClient();

  const {
    data: user,
    isLoading,
    isError,
    error,
    refetch,
  } = useQuery({
    queryKey: ['user'],
    queryFn: fetchCurrentUser,
    staleTime: 5 * 60 * 1000, // 5 minutes
    retry: false, // Don't retry on auth failure
  });

  /**
   * Check if the user is authenticated
   */
  const isAuthenticated = !!user && !isError;

  /**
   * Invalidate user query to force refetch
   * Useful after login/logout
   */
  const invalidate = () => {
    queryClient.invalidateQueries({ queryKey: ['user'] });
  };

  /**
   * Clear user data from cache
   * Useful on logout
   */
  const clear = () => {
    queryClient.setQueryData(['user'], null);
  };

  return {
    user,
    isLoading,
    isError,
    error,
    isAuthenticated,
    refetch,
    invalidate,
    clear,
  };
}
