// Prisma schema for Luma Web
// Database: PostgreSQL (via Supabase)

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// =============================================================================
// USER AUTHENTICATION
// =============================================================================

model User {
  id               String    @id @default(cuid())
  email            String    @unique
  passwordHash     String    @map("password_hash")
  emailVerified    Boolean   @default(false) @map("email_verified")
  failedLoginCount Int       @default(0) @map("failed_login_count")
  lockedUntil      DateTime? @map("locked_until")
  createdAt        DateTime  @default(now()) @map("created_at")
  updatedAt        DateTime  @updatedAt @map("updated_at")

  // Relationships
  courses             Course[]
  learningSessions    LearningSession[]
  quotas              Quota[]
  quotaLogs           QuotaLog[]
  aiUsageLogs         AIUsageLog[]
  userPreference      UserPreference?
  verificationTokens  VerificationToken[]

  @@index([email])
  @@index([lockedUntil])
  @@map("users")
}

model VerificationToken {
  id        String   @id @default(cuid())
  userId    String   @map("user_id")
  token     String   @unique
  type      TokenType
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")

  // Relationships
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([userId, type])
  @@index([expiresAt])
  @@map("verification_tokens")
}

enum TokenType {
  EMAIL_VERIFICATION
  PASSWORD_RESET
}

// =============================================================================
// COURSE & FILE MANAGEMENT
// =============================================================================

model Course {
  id        String   @id @default(cuid())
  userId    String   @map("user_id")
  name      String   // Max 50 chars (validated at app level)
  school    String
  term      String
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relationships
  user  User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  files File[]

  @@index([userId, createdAt(sort: Desc)])
  @@map("courses")
}

model File {
  id              String           @id @default(cuid())
  courseId        String           @map("course_id")
  name            String
  sizeBytes       BigInt           @map("size_bytes")
  pageCount       Int              @map("page_count")
  status          FileStatus       @default(UPLOADING)
  structureStatus StructureStatus  @default(PENDING) @map("structure_status")
  structureError  String?          @map("structure_error") @db.Text
  isScanned       Boolean          @default(false) @map("is_scanned")
  claudeFileId    String?          @map("claude_file_id") // For Claude File API
  supabaseUrl     String           @map("supabase_url")
  createdAt       DateTime         @default(now()) @map("created_at")
  updatedAt       DateTime         @updatedAt @map("updated_at")

  // Relationships
  course           Course            @relation(fields: [courseId], references: [id], onDelete: Cascade)
  topicGroups      TopicGroup[]
  learningSessions LearningSession[]

  @@index([courseId, createdAt(sort: Desc)])
  @@index([status])
  @@index([structureStatus])
  @@map("files")
}

enum FileStatus {
  UPLOADING
  PROCESSING
  READY
  FAILED
}

enum StructureStatus {
  PENDING
  PROCESSING
  READY
  FAILED
}

// =============================================================================
// AI INTERACTIVE TUTOR - KNOWLEDGE STRUCTURE
// =============================================================================

model TopicGroup {
  id        String   @id @default(cuid())
  fileId    String   @map("file_id")
  index     Int      // Order in the file
  title     String
  pageStart Int      @map("page_start")
  pageEnd   Int      @map("page_end")
  createdAt DateTime @default(now()) @map("created_at")

  // Relationships
  file      File       @relation(fields: [fileId], references: [id], onDelete: Cascade)
  subTopics SubTopic[]

  @@unique([fileId, index])
  @@index([fileId])
  @@map("topic_groups")
}

model SubTopic {
  id        String   @id @default(cuid())
  topicId   String   @map("topic_id")
  index     Int      // Order within TopicGroup
  title     String
  pageStart Int      @map("page_start")
  pageEnd   Int      @map("page_end")
  createdAt DateTime @default(now()) @map("created_at")

  // Relationships
  topicGroup        TopicGroup          @relation(fields: [topicId], references: [id], onDelete: Cascade)
  subTopicCache     SubTopicCache?
  subTopicProgress  SubTopicProgress[]
  qaMessages        QAMessage[]

  @@unique([topicId, index])
  @@index([topicId])
  @@map("sub_topics")
}

// =============================================================================
// AI INTERACTIVE TUTOR - LEARNING SESSIONS
// =============================================================================

model LearningSession {
  id              String         @id @default(cuid())
  userId          String         @map("user_id")
  fileId          String         @map("file_id")
  containerId     String?        @map("container_id") // Claude container ID
  status          SessionStatus  @default(IN_PROGRESS)
  currentTopicIdx Int            @default(0) @map("current_topic_idx")
  currentSubIdx   Int            @default(0) @map("current_sub_idx")
  createdAt       DateTime       @default(now()) @map("created_at")
  updatedAt       DateTime       @updatedAt @map("updated_at")
  completedAt     DateTime?      @map("completed_at")

  // Relationships
  user             User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  file             File               @relation(fields: [fileId], references: [id], onDelete: Cascade)
  subTopicProgress SubTopicProgress[]
  qaMessages       QAMessage[]

  @@unique([userId, fileId])
  @@index([userId])
  @@index([fileId])
  @@index([containerId])
  @@map("learning_sessions")
}

enum SessionStatus {
  IN_PROGRESS
  COMPLETED
}

model SubTopicProgress {
  id          String               @id @default(cuid())
  sessionId   String               @map("session_id")
  subTopicId  String               @map("sub_topic_id")
  status      SubTopicStatus       @default(PENDING)
  wrongCount  Int                  @default(0) @map("wrong_count") // Quiz wrong attempts
  completedAt DateTime?            @map("completed_at")
  createdAt   DateTime             @default(now()) @map("created_at")
  updatedAt   DateTime             @updatedAt @map("updated_at")

  // Relationships
  session  LearningSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  subTopic SubTopic        @relation(fields: [subTopicId], references: [id], onDelete: Cascade)

  @@unique([sessionId, subTopicId])
  @@index([sessionId])
  @@index([subTopicId])
  @@map("sub_topic_progress")
}

enum SubTopicStatus {
  PENDING
  PASSED
  SKIPPED
}

// =============================================================================
// AI INTERACTIVE TUTOR - CACHING
// =============================================================================

model SubTopicCache {
  id          String   @id @default(cuid())
  subTopicId  String   @unique @map("sub_topic_id")
  explanation String   @db.Text // Markdown/LaTeX content
  quiz        String   @db.Text // JSON: { question, options[], correct_answers[], explanation }
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relationships
  subTopic SubTopic @relation(fields: [subTopicId], references: [id], onDelete: Cascade)

  @@index([subTopicId])
  @@map("sub_topic_cache")
}

// =============================================================================
// AI INTERACTIVE TUTOR - Q&A
// =============================================================================

model QAMessage {
  id         String   @id @default(cuid())
  sessionId  String   @map("session_id")
  subTopicId String   @map("sub_topic_id")
  role       QARole
  content    String   @db.Text
  createdAt  DateTime @default(now()) @map("created_at")

  // Relationships
  session  LearningSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  subTopic SubTopic        @relation(fields: [subTopicId], references: [id], onDelete: Cascade)

  @@index([sessionId, subTopicId, createdAt])
  @@map("qa_messages")
}

enum QARole {
  USER
  ASSISTANT
}

// =============================================================================
// QUOTA MANAGEMENT
// =============================================================================

model Quota {
  id              String   @id @default(cuid())
  userId          String   @map("user_id")
  aiInteractions  Int      @default(500) @map("ai_interactions") // Monthly AI call limit
  resetAt         DateTime @map("reset_at") // Next reset date
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  // Relationships
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId])
  @@index([resetAt])
  @@map("quotas")
}

model QuotaLog {
  id         String   @id @default(cuid())
  userId     String   @map("user_id")
  oldValue   Int      @map("old_value")
  newValue   Int      @map("new_value")
  reason     String
  adjustedBy String?  @map("adjusted_by") // Admin ID if manually adjusted
  createdAt  DateTime @default(now()) @map("created_at")

  // Relationships
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt(sort: Desc)])
  @@map("quota_logs")
}

model AIUsageLog {
  id          String      @id @default(cuid())
  userId      String      @map("user_id")
  featureType FeatureType @map("feature_type")
  tokensUsed  Int         @map("tokens_used")
  createdAt   DateTime    @default(now()) @map("created_at")

  // Relationships
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt(sort: Desc)])
  @@index([featureType])
  @@map("ai_usage_logs")
}

enum FeatureType {
  EXPLAIN       // SubTopic explanation
  RELEARN       // Re-explain
  QA            // Q&A message
}

// =============================================================================
// USER PREFERENCES
// =============================================================================

model UserPreference {
  id            String   @id @default(cuid())
  userId        String   @unique @map("user_id")
  uiLocale      String   @default("en") @map("ui_locale") // en | zh
  explainLocale String   @default("en") @map("explain_locale") // en | zh
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  // Relationships
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_preferences")
}

// =============================================================================
// ADMIN
// =============================================================================

model Admin {
  id           String    @id @default(cuid())
  email        String    @unique
  passwordHash String    @map("password_hash")
  role         AdminRole @default(ADMIN)
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")

  @@index([email])
  @@map("admins")
}

enum AdminRole {
  ADMIN
  SUPER_ADMIN
}
