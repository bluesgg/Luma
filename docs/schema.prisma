// Luma Web - Prisma Schema
// 对应 TECH_DESIGN.md v1.0

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL") // 用于 Supabase 连接池
}

// ============================================
// 枚举类型
// ============================================

enum Role {
  student
  admin
}

enum AdminRole {
  super_admin
  admin
}

enum FileType {
  lecture
}

enum FileStatus {
  uploading
  processing
  ready
  failed
}

enum QuotaBucket {
  learningInteractions
  autoExplain
}

enum QuotaChangeReason {
  consume
  refund
  system_reset
  admin_adjust
}

enum AccessActionType {
  login
  view_file
  use_qa
  use_explain
}

enum AIActionType {
  qa
  explain
}

enum Locale {
  en
  zh
}

// ============================================
// 用户相关
// ============================================

/// 用户扩展信息（关联 Supabase auth.users）
model Profile {
  userId    String   @id @map("user_id") @db.Uuid
  role      Role     @default(student)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // 关系
  courses         Course[]
  files           File[]
  quotas          Quota[]
  quotaLogs       QuotaLog[]
  readingProgress ReadingProgress[]
  preference      UserPreference?
  accessLogs      AccessLog[]
  aiUsageLogs     AIUsageLog[]
  qas             QA[]

  @@map("profiles")
}

/// 用户偏好设置
model UserPreference {
  userId        String   @id @map("user_id") @db.Uuid
  uiLocale      Locale   @default(en) @map("ui_locale")
  explainLocale Locale   @default(en) @map("explain_locale")
  updatedAt     DateTime @updatedAt @map("updated_at")

  // 关系
  profile Profile @relation(fields: [userId], references: [userId], onDelete: Cascade)

  @@map("user_preferences")
}

// ============================================
// 课程与文件
// ============================================

/// 课程
model Course {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId    String   @map("user_id") @db.Uuid
  name      String   @db.VarChar(50)
  school    String?  @db.VarChar(100)
  term      String?  @db.VarChar(50)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // 关系
  profile Profile @relation(fields: [userId], references: [userId], onDelete: Cascade)
  files   File[]

  @@unique([userId, name])
  @@map("courses")
}

/// 文件（PDF）
model File {
  id          String     @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  courseId    String     @map("course_id") @db.Uuid
  userId      String     @map("user_id") @db.Uuid // 冗余字段便于查询
  name        String     @db.VarChar(255)
  type        FileType   @default(lecture)
  pageCount   Int?       @map("page_count")
  fileSize    BigInt?    @map("file_size") // 字节
  isScanned   Boolean    @default(false) @map("is_scanned")
  status      FileStatus @default(uploading)
  storagePath String?    @map("storage_path") @db.VarChar(500)
  createdAt   DateTime   @default(now()) @map("created_at")
  updatedAt   DateTime   @updatedAt @map("updated_at")

  // 关系
  course          Course            @relation(fields: [courseId], references: [id], onDelete: Cascade)
  profile         Profile           @relation(fields: [userId], references: [userId], onDelete: Cascade)
  explanations    Explanation[]
  imageRegions    ImageRegion[]
  qas             QA[]
  readingProgress ReadingProgress[]

  @@unique([courseId, name])
  @@index([userId])
  @@map("files")
}

// ============================================
// AI 生成内容
// ============================================

/// 页面讲解
model Explanation {
  id         String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  fileId     String   @map("file_id") @db.Uuid
  pageNumber Int      @map("page_number")
  content    String   @db.Text
  createdAt  DateTime @default(now()) @map("created_at")

  // 关系
  file File @relation(fields: [fileId], references: [id], onDelete: Cascade)

  @@unique([fileId, pageNumber])
  @@map("explanations")
}

/// 图片区域
model ImageRegion {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  fileId      String   @map("file_id") @db.Uuid
  pageNumber  Int      @map("page_number")
  bbox        Json     // {x, y, width, height}
  explanation String?  @db.Text
  createdAt   DateTime @default(now()) @map("created_at")

  // 关系
  file File @relation(fields: [fileId], references: [id], onDelete: Cascade)

  @@index([fileId, pageNumber])
  @@map("image_regions")
}

/// 问答记录
model QA {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  fileId    String   @map("file_id") @db.Uuid
  userId    String   @map("user_id") @db.Uuid // 冗余字段便于查询
  question  String   @db.Text
  answer    String   @db.Text
  pageRefs  Json?    @map("page_refs") // [1, 3, 5]
  createdAt DateTime @default(now()) @map("created_at")

  // 关系
  file    File    @relation(fields: [fileId], references: [id], onDelete: Cascade)
  profile Profile @relation(fields: [userId], references: [userId], onDelete: Cascade)

  @@index([userId])
  @@map("qas")
}

/// 阅读进度
model ReadingProgress {
  id         String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId     String   @map("user_id") @db.Uuid
  fileId     String   @map("file_id") @db.Uuid
  pageNumber Int      @map("page_number")
  updatedAt  DateTime @updatedAt @map("updated_at")

  // 关系
  profile Profile @relation(fields: [userId], references: [userId], onDelete: Cascade)
  file    File    @relation(fields: [fileId], references: [id], onDelete: Cascade)

  @@unique([userId, fileId])
  @@map("reading_progress")
}

// ============================================
// 配额管理
// ============================================

/// 用户配额
model Quota {
  id      String      @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId  String      @map("user_id") @db.Uuid
  bucket  QuotaBucket
  used    Int         @default(0)
  limit   Int // 150 或 300
  resetAt DateTime    @map("reset_at")

  // 关系
  profile Profile @relation(fields: [userId], references: [userId], onDelete: Cascade)

  @@unique([userId, bucket])
  @@map("quotas")
}

/// 配额变更日志
model QuotaLog {
  id        String            @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId    String            @map("user_id") @db.Uuid
  bucket    QuotaBucket
  change    Int // +1 消耗, -1 退还
  reason    QuotaChangeReason
  createdAt DateTime          @default(now()) @map("created_at")

  // 关系
  profile Profile @relation(fields: [userId], references: [userId], onDelete: Cascade)

  @@index([createdAt])
  @@map("quota_logs")
}

// ============================================
// 管理员（独立账户体系）
// ============================================

/// 管理员账户
model Admin {
  id           String     @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  email        String     @unique @db.VarChar(255)
  passwordHash String     @map("password_hash") @db.VarChar(255)
  role         AdminRole  @default(admin)
  createdAt    DateTime   @default(now()) @map("created_at")
  disabledAt   DateTime?  @map("disabled_at")

  // 关系
  auditLogs AuditLog[]

  @@map("admins")
}

/// 管理员操作审计日志
model AuditLog {
  id           String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  adminId      String   @map("admin_id") @db.Uuid
  action       String   @db.VarChar(50) // adjust_quota, disable_user 等
  targetUserId String?  @map("target_user_id") @db.Uuid
  details      Json?
  createdAt    DateTime @default(now()) @map("created_at")

  // 关系
  admin Admin @relation(fields: [adminId], references: [id], onDelete: Cascade)

  @@map("audit_logs")
}

// ============================================
// 日志
// ============================================

/// 访问日志
model AccessLog {
  id         String           @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId     String?          @map("user_id") @db.Uuid
  actionType AccessActionType @map("action_type")
  metadata   Json?
  timestamp  DateTime         @default(now())

  // 关系
  profile Profile? @relation(fields: [userId], references: [userId], onDelete: SetNull)

  @@index([timestamp])
  @@map("access_logs")
}

/// AI 使用日志
model AIUsageLog {
  id           String       @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId       String       @map("user_id") @db.Uuid
  actionType   AIActionType @map("action_type")
  inputTokens  Int          @map("input_tokens")
  outputTokens Int          @map("output_tokens")
  model        String       @db.VarChar(50)
  costCents    Int          @map("cost_cents") // 成本（分）
  createdAt    DateTime     @default(now()) @map("created_at")

  // 关系
  profile Profile @relation(fields: [userId], references: [userId], onDelete: Cascade)

  @@index([createdAt])
  @@map("ai_usage_logs")
}
